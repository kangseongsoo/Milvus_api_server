# Milvus 컬렉션 스키마 가이드

## 개요

Milvus 컬렉션의 스키마 구조와 각 필드의 역할에 대해 설명합니다. 향후 하이브리드 검색을 위한 sparse 임베딩 필드도 포함되어 있습니다.

## 컬렉션 스키마

### 필드 구조

| 필드명 | 타입 | 설명 | 용도 |
|--------|------|------|------|
| `id` | INT64 | 청크 고유 ID (자동 생성) | Primary Key |
| `doc_id` | INT64 | 문서 ID (PostgreSQL FK) | 문서 연결 |
| `chat_bot_id` | VARCHAR(100) | 챗봇 ID (파티션 키) | 파티션 분리 |
| `content_name` | VARCHAR(500) | 문서 고유 식별자 | 삭제 API용 |
| `chunk_index` | INT64 | 청크 순서 (0부터 시작) | 청크 순서 |
| `embedding_dense` | FLOAT_VECTOR(1536) | Dense 임베딩 벡터 | 벡터 검색 |
| `embedding_sparse` | SPARSE_FLOAT_VECTOR | Sparse 임베딩 벡터 | 하이브리드 검색 (향후) |
| `metadata` | JSON | 메타데이터 (필터링용) | 메타데이터 필터링 |

### 인덱스 구조

| 필드명 | 인덱스 타입 | 설명 |
|--------|-------------|------|
| `chat_bot_id` | 스칼라 인덱스 | 파티션 필터링용 |
| `doc_id` | 스칼라 인덱스 | 문서 ID 검색용 |
| `content_name` | 스칼라 인덱스 | 삭제 API용 |
| `embedding_dense` | HNSW | Dense 벡터 검색용 |
| `embedding_sparse` | SPARSE_INVERTED_INDEX | Sparse 벡터 검색용 (향후) |

## Sparse 임베딩 필드

### 현재 상태
- **필드 생성**: ✅ 항상 생성됨
- **기본값**: NULL (빈 리스트)
- **인덱스**: SPARSE_INVERTED_INDEX 생성됨
- **사용**: 향후 하이브리드 검색 고도화용

### 설정
```python
# app/config.py
USE_SPARSE_EMBEDDING: bool = True  # 기본값: True
```

### 향후 활용 계획
1. **하이브리드 검색**: Dense + Sparse 벡터 조합
2. **키워드 검색**: Sparse 벡터로 키워드 기반 검색
3. **검색 정확도 향상**: 의미적 검색 + 키워드 검색 결합

## 컬렉션 생성

### API 호출
```http
POST /collection/create
Content-Type: application/json

{
  "account_name": "chatty",
  "dimension": 1536
}
```

### 생성 과정
1. **스키마 생성**: 모든 필드와 인덱스 정의
2. **컬렉션 생성**: Milvus에 컬렉션 생성
3. **인덱스 생성**: 모든 필드에 대한 인덱스 생성
4. **완료**: 컬렉션 사용 준비 완료

## 벡터 삽입

### Dense 벡터 삽입
```python
# 현재 사용 중
entities = [
    [doc_id] * len(chunks),
    [chat_bot_id] * len(chunks),
    [content_name] * len(chunks),
    [chunk_index] * len(chunks),
    [embedding_dense] * len(chunks),  # OpenAI 임베딩
    [metadata] * len(chunks),
    [[]] * len(chunks)  # sparse_embedding (NULL)
]
```

### 향후 Sparse 벡터 삽입
```python
# 향후 하이브리드 검색 시
entities = [
    [doc_id] * len(chunks),
    [chat_bot_id] * len(chunks),
    [content_name] * len(chunks),
    [chunk_index] * len(chunks),
    [embedding_dense] * len(chunks),  # OpenAI 임베딩
    [metadata] * len(chunks),
    [sparse_embedding] * len(chunks)  # BM25 또는 SPLADE 임베딩
]
```

## 검색 방식

### 현재 (Dense Only)
```python
# Dense 벡터 검색만 사용
search_params = {
    "metric_type": "COSINE",
    "params": {"ef": 64}
}
```

### 향후 (Hybrid)
```python
# Dense + Sparse 하이브리드 검색
search_params = {
    "metric_type": "COSINE",
    "params": {"ef": 64}
}

# Sparse 벡터 검색
sparse_search_params = {
    "metric_type": "IP",  # Inner Product
    "params": {}
}
```

## 테스트

컬렉션 스키마를 테스트하려면:

```bash
cd TEST_DATA
python test_collection_schema.py
```

### 테스트 항목
1. **컬렉션 생성**: 새 컬렉션 생성 테스트
2. **스키마 확인**: 모든 필드가 올바르게 생성되었는지 확인
3. **Sparse 필드 확인**: `embedding_sparse` 필드 존재 여부 확인
4. **인덱스 확인**: 모든 인덱스가 올바르게 생성되었는지 확인

## 주의사항

1. **Sparse 필드**: 현재는 NULL 값으로 저장되며, 향후 하이브리드 검색 시 활용 예정
2. **인덱스**: Sparse 벡터 인덱스도 미리 생성되어 있어 향후 즉시 사용 가능
3. **호환성**: 기존 Dense 벡터 검색은 그대로 동작하며, Sparse 필드 추가로 인한 영향 없음
4. **성능**: Sparse 필드가 NULL이므로 현재 성능에 영향 없음

## 관련 파일

- `app/schemas/milvus_schema.py`: 스키마 정의
- `app/core/milvus_client.py`: 컬렉션 생성 및 관리
- `app/config.py`: Sparse 임베딩 설정
- `TEST_DATA/test_collection_schema.py`: 스키마 테스트
