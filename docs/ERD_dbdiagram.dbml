// Milvus + PostgreSQL RAG ì‹œìŠ¤í…œ ERD
// DBdiagram.ioì—ì„œ ì‹œê°í™” ê°€ëŠ¥

Project Milvus_RAG_API {
  database_type: 'PostgreSQL'
  Note: '''
    # ğŸ—„ï¸ Milvus + PostgreSQL RAG ì‹œìŠ¤í…œ ERD
    
    ## ğŸ“Š ì‹œìŠ¤í…œ ê°œìš”
    - **PostgreSQL**: ë©”íƒ€ë°ì´í„° ë° ë¬¸ì„œ ê´€ë¦¬ (íŒŒí‹°ì…”ë‹)
    - **Milvus**: ë²¡í„° ì„ë² ë”© ê²€ìƒ‰ (íŒŒí‹°ì…”ë‹)
    - **ê³„ì • ë ˆë²¨**: chatty â†’ collection_chatty + rag_db_chatty
    - **ë´‡ ë ˆë²¨**: bot_id â†’ PostgreSQL íŒŒí‹°ì…˜ + Milvus íŒŒí‹°ì…˜
    
    ## ğŸ¯ í•µì‹¬ íŠ¹ì§•
    - íŒŒí‹°ì…˜ í”„ë£¨ë‹ìœ¼ë¡œ 3ì–µ ê±´ë„ 300ë§Œ ê±´ì²˜ëŸ¼ ë¹ ë¥´ê²Œ!
    - ì™„ë²½í•œ ëŒ€ì¹­ êµ¬ì¡° (PostgreSQL â†” Milvus)
    - ë¬¸ì„œ ê³ ìœ  ì‹ë³„ì(content_name)ë¡œ ì‚­ì œ ì§€ì›
  '''
}

// =============================================
// PostgreSQL í…Œì´ë¸” êµ¬ì¡°
// =============================================

Table bot_registry {
  bot_id varchar(100) [pk, note: 'UUID ë´‡ ID']
  bot_name varchar(255) [not null, note: 'ë´‡ ì´ë¦„']
  partition_name varchar(255) [unique, not null, note: 'Milvus íŒŒí‹°ì…˜ëª…']
  description text [note: 'ë´‡ ì„¤ëª…']
  created_at timestamp [default: `now()`, note: 'ìƒì„± ì‹œê°„']
  metadata jsonb [note: 'ì¶”ê°€ ë©”íƒ€ë°ì´í„°']
  
  Note: '''
    # ë´‡ ë ˆì§€ìŠ¤íŠ¸ë¦¬
    - ê° ë´‡ì˜ ê¸°ë³¸ ì •ë³´ì™€ Milvus íŒŒí‹°ì…˜ëª… ë§¤í•‘
    - ì˜ˆì‹œ: 550e8400-... â†’ bot_550e8400e29b41d4a716446655440000
  '''
}

Table documents {
  doc_id bigserial [pk, note: 'ë¬¸ì„œ ID (ì‹œí€€ìŠ¤)']
  chat_bot_id varchar(100) [ref: > bot_registry.bot_id, note: 'ë´‡ ID (íŒŒí‹°ì…˜ í‚¤)']
  content_name varchar(500) [unique, not null, note: 'ë¬¸ì„œ ê³ ìœ  ì‹ë³„ì (URL, íŒŒì¼ëª…, ì œëª© ë“±)']
  chunk_count int [default: 0, note: 'ì´ ì²­í¬ ìˆ˜']
  created_at timestamp [default: `now()`, note: 'ìƒì„± ì‹œê°„']
  updated_at timestamp [default: `now()`, note: 'ìˆ˜ì • ì‹œê°„']
  metadata jsonb [note: 'ìƒì„¸ ë©”íƒ€ë°ì´í„° (ëª¨ë“  ì •ë³´ ì €ì¥)']
  
  Note: '''
    # ë¬¸ì„œ í…Œì´ë¸” (íŒŒí‹°ì…”ë‹)
    - chat_bot_idë¡œ íŒŒí‹°ì…”ë‹
    - content_nameìœ¼ë¡œ ê³ ìœ  ë¬¸ì„œ ì‹ë³„ ë° ì‚­ì œ
    - íŒŒí‹°ì…˜ ì˜ˆì‹œ: documents_550e8400e29b41d4a716446655440000
  '''
}

Table document_chunks {
  chunk_id bigserial [pk, note: 'ì²­í¬ ID']
  doc_id bigint [ref: > documents.doc_id, note: 'ë¬¸ì„œ ID']
  chat_bot_id varchar(100) [ref: > bot_registry.bot_id, note: 'ë´‡ ID (íŒŒí‹°ì…˜ í‚¤)']
  chunk_index int [not null, note: 'ì²­í¬ ìˆœì„œ']
  chunk_text text [not null, note: 'ì²­í¬ í…ìŠ¤íŠ¸']
  created_at timestamp [default: `now()`, note: 'ìƒì„± ì‹œê°„']
  
  Note: '''
    # ì²­í¬ í…Œì´ë¸” (íŒŒí‹°ì…”ë‹)
    - chat_bot_idë¡œ íŒŒí‹°ì…”ë‹
    - doc_id + chat_bot_idë¡œ documentsì™€ ì—°ê²°
    - íŒŒí‹°ì…˜ ì˜ˆì‹œ: document_chunks_550e8400e29b41d4a716446655440000
  '''
}

// =============================================
// Milvus ì»¬ë ‰ì…˜ ìŠ¤í‚¤ë§ˆ (ê°€ìƒ í…Œì´ë¸”ë¡œ í‘œí˜„)
// =============================================

Table collection_chatty {
  id int64 [pk, note: 'ìë™ ì¦ê°€ ID']
  chat_bot_id varchar [note: 'ë´‡ ID (í•„í„°ë§ìš©)']
  content_name varchar [note: 'ë¬¸ì„œ ê³ ìœ  ì‹ë³„ì']
  doc_id int64 [note: 'ë¬¸ì„œ ID (PostgreSQL FK)']
  chunk_index int64 [note: 'ì²­í¬ ì¸ë±ìŠ¤']
  embedding_dense float_vector [note: 'Dense ì„ë² ë”© ë²¡í„° (1536ì°¨ì›)']
  embedding_sparse float_vector [note: 'Sparse ì„ë² ë”© ë²¡í„° (í–¥í›„ ê³ ë„í™”ìš©)']
  metadata json [note: 'ë©”íƒ€ë°ì´í„° (expr í•„í„°ë§ìš©)']
  
  Note: '''
    # Milvus ì»¬ë ‰ì…˜: collection_chatty
    
    ## íŒŒí‹°ì…˜ êµ¬ì¡°
    - bot_550e8400e29b41d4a716446655440000 (ë‰´ìŠ¤ë´‡ ë²¡í„°)
    - bot_7c9e6679742540de944be07fc1f90ae7 (ë²•ë¥ ë´‡ ë²¡í„°)
    - bot_8a7f5678823451efb345567890abcdef (ì˜ë£Œë´‡ ë²¡í„°)
    
    ## ì¸ë±ìŠ¤
    - embedding_dense: HNSW (COSINE) - ì˜ë¯¸ì  ê²€ìƒ‰
    - embedding_sparse: SPARSE_INVERTED_INDEX (IP) - í‚¤ì›Œë“œ ê²€ìƒ‰
  '''
}

// =============================================
// ê´€ê³„ ì •ì˜
// =============================================

Ref: documents.chat_bot_id > bot_registry.bot_id [delete: cascade]
Ref: document_chunks.doc_id > documents.doc_id [delete: cascade]
Ref: document_chunks.chat_bot_id > bot_registry.bot_id [delete: cascade]

// Milvusì™€ PostgreSQL ê°„ì˜ ë…¼ë¦¬ì  ì—°ê²° (ì‹¤ì œ FKëŠ” ì•„ë‹˜)
Ref: collection_chatty.chat_bot_id - bot_registry.bot_id [note: 'ë´‡ ì‹ë³„ ë§¤í•‘']
Ref: collection_chatty.content_name - documents.content_name [note: 'ë¬¸ì„œ ê³ ìœ  ì‹ë³„ì']
Ref: collection_chatty.doc_id - documents.doc_id [note: 'ë¬¸ì„œ ì—°ê²°']

// =============================================
// ì¸ë±ìŠ¤ ì •ì˜
// =============================================

TableGroup "PostgreSQL ì¸ë±ìŠ¤" {
  Table documents {
    index idx_documents_chat_bot_created [chat_bot_id, created_at]
    index idx_documents_content_name [content_name]
    index idx_documents_metadata [metadata] [type: gin]
  }
  
  Table document_chunks {
    index idx_chunks_doc_bot [doc_id, chat_bot_id]
    index idx_chunks_index [chunk_index]
  }
}

TableGroup "Milvus ì¸ë±ìŠ¤" {
  Table collection_chatty {
    index idx_dense_embedding [embedding_dense] [type: hnsw, note: 'HNSW (COSINE)']
    index idx_sparse_embedding [embedding_sparse] [type: sparse_inverted, note: 'SPARSE_INVERTED_INDEX (IP)']
  }
}

// =============================================
// íŒŒí‹°ì…˜ ì •ë³´
// =============================================

TableGroup "PostgreSQL íŒŒí‹°ì…˜" {
  Table documents_partition_news {
    doc_id bigserial [pk]
    chat_bot_id varchar(100) [note: '550e8400-e29b-41d4-a716-446655440000']
    content_name varchar(500)
    chunk_count int
    created_at timestamp
    updated_at timestamp
    metadata jsonb
    
    Note: '''
      # documents_550e8400e29b41d4a716446655440000
      ë‰´ìŠ¤ë´‡ ë¬¸ì„œ íŒŒí‹°ì…˜
    '''
  }
  
  Table document_chunks_partition_news {
    chunk_id bigserial [pk]
    doc_id bigint
    chat_bot_id varchar(100) [note: '550e8400-e29b-41d4-a716-446655440000']
    chunk_index int
    chunk_text text
    created_at timestamp
    
    Note: '''
      # document_chunks_550e8400e29b41d4a716446655440000
      ë‰´ìŠ¤ë´‡ ì²­í¬ íŒŒí‹°ì…˜
    '''
  }
}

TableGroup "Milvus íŒŒí‹°ì…˜" {
  Table milvus_partition_news {
    id int64 [pk]
    chat_bot_id varchar [note: '550e8400-e29b-41d4-a716-446655440000']
    content_name varchar
    doc_id int64
    chunk_index int64
    embedding_dense float_vector
    embedding_sparse float_vector
    metadata json
    
    Note: '''
      # collection_chatty/bot_550e8400e29b41d4a716446655440000
      ë‰´ìŠ¤ë´‡ ë²¡í„° íŒŒí‹°ì…˜
    '''
  }
}

// =============================================
// ë°ì´í„° íë¦„ ë° ë§¤í•‘
// =============================================

TableGroup "ì‹œìŠ¤í…œ ë§¤í•‘" {
  Table mapping_table {
    postgres_table varchar [note: 'PostgreSQL í…Œì´ë¸”']
    milvus_collection varchar [note: 'Milvus ì»¬ë ‰ì…˜/íŒŒí‹°ì…˜']
    connection_key varchar [note: 'ì—°ê²° í‚¤']
    purpose varchar [note: 'ìš©ë„']
    
    Note: '''
      # PostgreSQL â†” Milvus ë§¤í•‘ ê´€ê³„
      
      | PostgreSQL | Milvus | ì—°ê²° í‚¤ | ìš©ë„ |
      |-----------|--------|---------|------|
      | bot_registry.bot_id | collection_chatty[partition].chat_bot_id | ë´‡ ì‹ë³„ | ë´‡ ì‹ë³„ |
      | bot_registry.partition_name | collection_chatty[partition_name] | íŒŒí‹°ì…˜ ë§¤í•‘ | íŒŒí‹°ì…˜ ë§¤í•‘ â­ |
      | documents.content_name | collection_chatty.content_name | ë¬¸ì„œ ê³ ìœ  ì‹ë³„ì | ë¬¸ì„œ ì‹ë³„ |
      | documents.doc_id | collection_chatty.doc_id | ë¬¸ì„œ ì—°ê²° | ë¬¸ì„œ ì—°ê²° |
      | document_chunks.chunk_index | collection_chatty.chunk_index | ì²­í¬ ìˆœì„œ | ì²­í¬ ìˆœì„œ |
      | document_chunks.chunk_text | collection_chatty.embedding_dense | ì„ë² ë”© ë³€í™˜ | ë²¡í„° ê²€ìƒ‰ |
    '''
  }
}
