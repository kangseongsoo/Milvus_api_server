# 삭제 API 가이드

## 개요

여러 `content_name` 기준으로 문서와 모든 청크를 일괄 삭제하는 API입니다. PostgreSQL과 Milvus에서 해당 문서들의 모든 데이터를 완전히 제거합니다.

**Saga Pattern 적용:**
- 데이터 일관성 보장
- 부분 실패 시 자동 복구
- 여러 문서 일괄 처리로 성능 향상

**POST 메서드 사용 이유:**
- 요청 본문에 안전하게 데이터 전달
- URL이 깔끔하고 로그에 민감한 정보 노출 방지
- 복잡한 데이터 구조 지원 가능
- RESTful 설계 원칙 준수

## API 엔드포인트

### 문서 일괄 삭제 (여러 content_name 기준)

```http
POST /data/document/delete
Content-Type: application/json

{
  "content_names": [
    "test_document_001",
    "test_document_002",
    "test_document_003"
  ],
  "account_name": "chatty",
  "chat_bot_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

#### 요청 본문

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| `content_names` | string[] | ✅ | 삭제할 문서들의 고유 식별자 리스트 |
| `account_name` | string | ✅ | 계정명 |
| `chat_bot_id` | string | ✅ | 챗봇 ID (UUID) |

#### 응답

**성공 (200 OK):**
```json
{
  "status": "success",
  "message": "Multiple documents and all chunks deleted successfully",
  "deleted_documents": 3,
  "deleted_chunks": 45,
  "deleted_vectors": 45,
  "postgres_delete_time_ms": 67.8,
  "milvus_delete_time_ms": 234.5,
  "total_time_ms": 302.3
}
```

**문서 없음 (404 Not Found):**
```json
{
  "detail": "Documents not found: content_names=['test_document_001', 'test_document_002']"
}
```

**서버 오류 (500 Internal Server Error):**
```json
{
  "detail": "PostgreSQL batch deletion failed: connection timeout"
}
```

## 동작 방식 (Saga Pattern)

### 1. Milvus 벡터 일괄 삭제 (먼저)
- 여러 `content_names`와 `chat_bot_id`로 필터링하여 모든 벡터 일괄 삭제
- 삭제된 벡터 수 반환
- 실패 시 전체 작업 중단

### 2. PostgreSQL 문서 일괄 삭제 (나중에)
- 여러 `content_names`와 `chat_bot_id`로 해당 파티션에서 문서들 검색
- 문서들과 연결된 모든 청크 삭제 (CASCADE)
- 삭제된 문서 수와 청크 수 반환

### 3. 보상 트랜잭션 (PostgreSQL 실패 시)
- PostgreSQL 삭제 실패 시 Milvus 복구 시도
- 데이터 일관성 보장

### 4. 자동 Flush
- 삭제 후 자동으로 flush 마킹
- 0.5초 이내에 검색 결과에서 제외됨

## 사용 예시

### cURL
```bash
curl -X POST "http://localhost:8000/data/document/delete" \
  -H "Content-Type: application/json" \
  -d '{
    "content_names": [
      "test_document_001",
      "test_document_002",
      "test_document_003"
    ],
    "account_name": "chatty",
    "chat_bot_id": "550e8400-e29b-41d4-a716-446655440000"
  }'
```

### Python (httpx)
```python
import httpx

async def delete_documents():
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "http://localhost:8000/data/document/delete",
            json={
                "content_names": [
                    "test_document_001",
                    "test_document_002",
                    "test_document_003"
                ],
                "account_name": "chatty",
                "chat_bot_id": "550e8400-e29b-41d4-a716-446655440000"
            }
        )
        
        if response.status_code == 200:
            result = response.json()
            print(f"일괄 삭제 완료:")
            print(f"  - 삭제된 문서: {result['deleted_documents']}개")
            print(f"  - 삭제된 청크: {result['deleted_chunks']}개")
            print(f"  - 삭제된 벡터: {result['deleted_vectors']}개")
        else:
            print(f"삭제 실패: {response.text}")
```

### JavaScript (fetch)
```javascript
async function deleteDocuments() {
    const response = await fetch('http://localhost:8000/data/document/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            content_names: [
                'test_document_001',
                'test_document_002',
                'test_document_003'
            ],
            account_name: 'chatty',
            chat_bot_id: '550e8400-e29b-41d4-a716-446655440000'
        })
    });
    
    if (response.ok) {
        const result = await response.json();
        console.log('일괄 삭제 완료:');
        console.log(`  - 삭제된 문서: ${result.deleted_documents}개`);
        console.log(`  - 삭제된 청크: ${result.deleted_chunks}개`);
        console.log(`  - 삭제된 벡터: ${result.deleted_vectors}개`);
    } else {
        console.error('삭제 실패:', await response.text());
    }
}
```

## 테스트

테스트 스크립트를 실행하여 API를 테스트할 수 있습니다:

```bash
cd TEST_DATA
python test_delete_api.py
```

## 주의사항

1. **영구 삭제**: 이 API는 데이터를 영구적으로 삭제합니다. 복구가 불가능합니다.

2. **파티션 기반**: 해당 `chat_bot_id`의 파티션에서만 삭제됩니다.

3. **Saga Pattern**: Milvus 먼저 삭제 → PostgreSQL 나중에 삭제 → 실패 시 보상 트랜잭션

4. **일괄 처리**: 여러 문서를 한 번에 삭제하여 성능 향상

5. **실시간 반영**: 삭제 후 0.5초 이내에 검색 결과에서 제외됩니다.

## 에러 처리

| HTTP 상태 코드 | 설명 | 해결 방법 |
|---------------|------|----------|
| 404 | 문서들을 찾을 수 없음 | `content_names`와 `chat_bot_id` 확인 |
| 500 | 서버 내부 오류 | 서버 로그 확인, 데이터베이스 연결 상태 점검 |

## 성능 특성

- **Milvus**: 인덱스 기반으로 빠른 벡터 일괄 삭제 (평균 100ms 이내)
- **PostgreSQL**: 파티션 기반으로 빠른 문서 일괄 삭제 (평균 50ms 이내)
- **일괄 처리**: 여러 문서를 한 번에 처리하여 네트워크 오버헤드 감소
- **총 소요 시간**: 일반적으로 200ms 이내 (문서 수에 따라 선형 증가)

## 관련 API

- [문서 삽입 API](./01. INSERT_DOCUMENT.md)
- [검색 API](./03. SEARCH_API.md)
- [봇 전체 삭제 API](./README.md) (chat_bot_id 기준)

## 변경 이력

- **v2.0**: 여러 `content_name` 일괄 삭제 지원, Saga Pattern 적용
- **v1.0**: 단일 `content_name` 삭제 지원
