# ğŸ“„ ë¬¸ì„œ ì‚½ì… API ëª…ì„¸ì„œ

## ğŸ“‹ ê°œìš”

RAG ì‹œìŠ¤í…œì— ë¬¸ì„œë¥¼ ì‚½ì…í•˜ëŠ” APIì…ë‹ˆë‹¤. ë‹¨ì¼ ë¬¸ì„œ ì‚½ì…ê³¼ ë°°ì¹˜ ë¬¸ì„œ ì‚½ì…ì„ ì§€ì›í•˜ë©°, ìë™ ì¤‘ë³µ ì²˜ë¦¬ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

- **ì¤‘ë³µ ê²€ì‚¬**: `/data/check-duplicates` - ì‚½ì… ì „ ì¤‘ë³µ ë¬¸ì„œ í™•ì¸
- **ë‹¨ì¼ ì‚½ì…**: `/data/insert` - í•˜ë‚˜ì˜ ë¬¸ì„œë¥¼ ì‚½ì… (ìë™ ì¤‘ë³µ ìŠ¤í‚µ)
- **ë°°ì¹˜ ì‚½ì…**: `/data/insert/batch` - ì—¬ëŸ¬ ë¬¸ì„œë¥¼ í•œ ë²ˆì— ì‚½ì… (ë¶€ë¶„ ì„±ê³µ ì§€ì›)

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

### ë°ì´í„° ì €ì¥ êµ¬ì¡°
```
ğŸ“„ ë¬¸ì„œ 1ê°œ â†’ ì—¬ëŸ¬ ì²­í¬
â”œâ”€â”€ PostgreSQL (ë©”íƒ€ë°ì´í„° + ì²­í¬ í…ìŠ¤íŠ¸)
â”‚   â”œâ”€â”€ documents í…Œì´ë¸” (ë¬¸ì„œ ë©”íƒ€ë°ì´í„°)
â”‚   â””â”€â”€ document_chunks í…Œì´ë¸” (ì²­í¬ í…ìŠ¤íŠ¸)
â””â”€â”€ Milvus (ë²¡í„° ì„ë² ë”©)
    â”œâ”€â”€ embedding_dense (Dense ë²¡í„°)
    â””â”€â”€ embedding_sparse (Sparse ë²¡í„°, í–¥í›„ ê³ ë„í™”ìš©)
```

### ë°ì´í„° íë¦„
```
1. API ìš”ì²­ â†’ 2. ë©”íƒ€ë°ì´í„° ë¶„ë¦¬ â†’ 3. PostgreSQL ì €ì¥ â†’ 4. Milvus ì €ì¥
```

---

## ğŸ”— API ì—”ë“œí¬ì¸íŠ¸

### 0ï¸âƒ£ ì¤‘ë³µ ê²€ì‚¬ (ì‚½ì… ì „ í™•ì¸)

#### **ì—”ë“œí¬ì¸íŠ¸**
```
POST /data/check-duplicates
```

#### **ì„¤ëª…**
ë¬¸ì„œë¥¼ ì‚½ì…í•˜ê¸° ì „ì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë¬¸ì„œë¥¼ í™•ì¸í•˜ëŠ” APIì…ë‹ˆë‹¤. ì—¬ëŸ¬ ë¬¸ì„œë¥¼ í•œ ë²ˆì— í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©°, ì¤‘ë³µëœ ë¬¸ì„œì™€ ì¤‘ë³µë˜ì§€ ì•Šì€ ë¬¸ì„œë¥¼ êµ¬ë¶„í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.

**ì¤‘ë³µ ê¸°ì¤€**: `chat_bot_id` + `content_name` ì¡°í•©ì´ ë™ì¼í•œ ê²½ìš°

#### **ìš”ì²­ ìŠ¤í‚¤ë§ˆ**
```json
{
  "account_name": "string",           // ê³„ì •ëª… (í•„ìˆ˜)
  "chat_bot_id": "string",            // ì±—ë´‡ ID (UUID, í•„ìˆ˜)
  "content_name": [                   // ì¤‘ë³µ ê²€ì‚¬í•  ë¬¸ì„œ ê³ ìœ  ì‹ë³„ì ë¦¬ìŠ¤íŠ¸ (í•„ìˆ˜)
    "string"
  ]
}
```

#### **ìš”ì²­ ì˜ˆì‹œ**
```bash
curl -X POST "http://localhost:8000/data/check-duplicates" \
  -H "Content-Type: application/json" \
  -d '{
    "account_name": "chatty",
    "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
    "content_name": [
      "http://m.segye.com/view/20250708507792",
      "http://m.segye.com/view/20250708512077",
      "https://chatty.kr/"
    ]
  }'
```

#### **Python ì˜ˆì‹œ**
```python
import requests

url = "http://localhost:8000/data/check-duplicates"
data = {
    "account_name": "chatty",
    "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
    "content_name": [
        "http://m.segye.com/view/20250708507792",
        "http://m.segye.com/view/20250708512077",
        "https://chatty.kr/"
    ]
}

response = requests.post(url, json=data)
print(response.json())
```

#### **ì‘ë‹µ ìŠ¤í‚¤ë§ˆ**
```json
{
  "status": "success",
  "total_requested": 3,                    // ìš”ì²­ëœ ë¬¸ì„œ ìˆ˜
  "duplicate_count": 2,                    // ì¤‘ë³µëœ ë¬¸ì„œ ìˆ˜
  "unique_count": 1,                       // ì¤‘ë³µë˜ì§€ ì•Šì€ ë¬¸ì„œ ìˆ˜
  "duplicate_content_names": [             // ì¤‘ë³µëœ ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸
    "http://m.segye.com/view/20250708507792",
    "http://m.segye.com/view/20250708512077"
  ],
  "unique_content_names": [                // ì¤‘ë³µë˜ì§€ ì•Šì€ ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸
    "https://chatty.kr/"
  ]
}
```

#### **ì‘ë‹µ ì˜ˆì‹œ**
```json
{
  "status": "success",
  "total_requested": 3,
  "duplicate_count": 2,
  "unique_count": 1,
  "duplicate_content_names": [
    "http://m.segye.com/view/20250708507792",
    "http://m.segye.com/view/20250708512077"
  ],
  "unique_content_names": [
    "https://chatty.kr/"
  ]
}
```

#### **ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤**

**ì˜µì…˜ 1: ì¤‘ë³µ ê²€ì‚¬ í›„ ì‚½ì… (ì„ íƒì )**
```python
# ì¤‘ë³µ ê²€ì‚¬ëŠ” ì„ íƒì‚¬í•­ - ë°”ë¡œ ì‚½ì…í•´ë„ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë¨
check_response = requests.post(
    "http://localhost:8000/data/check-duplicates",
    json={
        "account_name": "chatty",
        "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
        "content_name": ["doc1", "doc2", "doc3"]
    }
)

result = check_response.json()
print(f"ì¤‘ë³µ: {result['duplicate_count']}ê°œ, ì‹ ê·œ: {result['unique_count']}ê°œ")
```

**ì˜µì…˜ 2: ë°”ë¡œ ì‚½ì… (ê¶Œì¥)**
```python
# ì¤‘ë³µ ê²€ì‚¬ ì—†ì´ ë°”ë¡œ ì‚½ì…í•˜ë©´ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë¨
insert_response = requests.post(
    "http://localhost:8000/data/insert/batch",
    json={
        "account_name": "chatty",
        "documents": [...]  # ì¤‘ë³µëœ ë¬¸ì„œëŠ” ìë™ ìŠ¤í‚µ
    }
)

result = insert_response.json()
print(f"ì„±ê³µ: {result['success_count']}ê°œ, ì‹¤íŒ¨: {result['failure_count']}ê°œ")
```

---

### 1ï¸âƒ£ ë‹¨ì¼ ë¬¸ì„œ ì‚½ì…

#### **ì—”ë“œí¬ì¸íŠ¸**
```
POST /data/insert
```

#### **ìš”ì²­ ìŠ¤í‚¤ë§ˆ**
```json
{
  "account_name": "string",           // ê³„ì •ëª… (í•„ìˆ˜)
  "chat_bot_id": "string",            // ì±—ë´‡ ID (UUID, í•„ìˆ˜)
  "content_name": "string",           // ë¬¸ì„œ ê³ ìœ  ì‹ë³„ì (í•„ìˆ˜)
  "chunks": [                         // ì²­í¬ ë°°ì—´ (í•„ìˆ˜)
    {
      "chunk_index": 0,               // ì²­í¬ ìˆœì„œ (í•„ìˆ˜)
      "text": "string"                // ì²­í¬ í…ìŠ¤íŠ¸ (í•„ìˆ˜)
    }
  ],
  "metadata": {                       // ë©”íƒ€ë°ì´í„° (ì„ íƒ)
    "title": "string",
    "author": "string",
    "content_type": "string",
    "source_type": "string",
    "tags": ["string"]
  }
}
```

#### **ìš”ì²­ ì˜ˆì‹œ**
```bash
curl -X POST "http://localhost:8000/data/insert" \
  -H "Content-Type: application/json" \
  -d '{
    "account_name": "chatty",
    "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
    "content_name": "https://example.com/article1",
    "chunks": [
      {
        "chunk_index": 0,
        "text": "ì²« ë²ˆì§¸ ë¬¸ë‹¨ì…ë‹ˆë‹¤. ì¸ê³µì§€ëŠ¥ì— ëŒ€í•œ ë‚´ìš©ì…ë‹ˆë‹¤."
      },
      {
        "chunk_index": 1,
        "text": "ë‘ ë²ˆì§¸ ë¬¸ë‹¨ì…ë‹ˆë‹¤. ë¨¸ì‹ ëŸ¬ë‹ ì•Œê³ ë¦¬ì¦˜ì— ëŒ€í•´ ì„¤ëª…í•©ë‹ˆë‹¤."
      }
    ],
    "metadata": {
      "title": "AI í•™ìŠµ ê°€ì´ë“œ",
      "author": "ê¹€ê°œë°œ",
      "content_type": "html",
      "source_type": "url",
      "tags": ["AI", "ë¨¸ì‹ ëŸ¬ë‹", "í•™ìŠµ"]
    }
  }'
```

#### **Python ì˜ˆì‹œ**
```python
import requests

url = "http://localhost:8000/data/insert"
data = {
    "account_name": "chatty",
    "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
    "content_name": "https://example.com/article1",
    "chunks": [
        {
            "chunk_index": 0,
            "text": "ì²« ë²ˆì§¸ ë¬¸ë‹¨ì…ë‹ˆë‹¤. ì¸ê³µì§€ëŠ¥ì— ëŒ€í•œ ë‚´ìš©ì…ë‹ˆë‹¤."
        },
        {
            "chunk_index": 1,
            "text": "ë‘ ë²ˆì§¸ ë¬¸ë‹¨ì…ë‹ˆë‹¤. ë¨¸ì‹ ëŸ¬ë‹ ì•Œê³ ë¦¬ì¦˜ì— ëŒ€í•´ ì„¤ëª…í•©ë‹ˆë‹¤."
        }
    ],
    "metadata": {
        "title": "AI í•™ìŠµ ê°€ì´ë“œ",
        "author": "ê¹€ê°œë°œ",
        "content_type": "html",
        "source_type": "url",
        "tags": ["AI", "ë¨¸ì‹ ëŸ¬ë‹", "í•™ìŠµ"]
    }
}

response = requests.post(url, json=data)
print(response.json())
```

#### **ì‘ë‹µ ìŠ¤í‚¤ë§ˆ**

**ì„±ê³µ ì‘ë‹µ**:
```json
{
  "status": "success",
  "doc_id": 32,                        // ìƒì„±ëœ ë¬¸ì„œ ID
  "total_chunks": 2,                   // ì´ ì²­í¬ ìˆ˜
  "skipped": false,                    // ì¤‘ë³µ ìŠ¤í‚µ ì—¬ë¶€
  "error_message": null,               // ì—ëŸ¬ ë©”ì‹œì§€
  "postgres_insert_time_ms": 45.2,     // PostgreSQL ì‚½ì… ì‹œê°„
  "embedding_time_ms": 120.5,          // ì„ë² ë”© ìƒì„± ì‹œê°„
  "milvus_insert_time_ms": 123.4,      // Milvus ì‚½ì… ì‹œê°„
  "total_time_ms": 168.6               // ì´ ì²˜ë¦¬ ì‹œê°„
}
```

**ì¤‘ë³µ ìŠ¤í‚µ ì‘ë‹µ**:
```json
{
  "status": "skipped",
  "doc_id": null,                      // ì¤‘ë³µ ì‹œ null
  "total_chunks": 2,                   // ì´ ì²­í¬ ìˆ˜
  "skipped": true,                     // ì¤‘ë³µ ìŠ¤í‚µ ì—¬ë¶€
  "error_message": "ë¬¸ì„œê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: https://example.com/article1",
  "postgres_insert_time_ms": 0.0,
  "embedding_time_ms": 0.0,
  "milvus_insert_time_ms": 0.0,
  "total_time_ms": 5.2                 // ì²´í¬ ì‹œê°„ë§Œ ì†Œìš”
}
```

---

### 2ï¸âƒ£ ë°°ì¹˜ ë¬¸ì„œ ì‚½ì…

#### **ì—”ë“œí¬ì¸íŠ¸**
```
POST /data/insert/batch
```

#### **ìš”ì²­ ìŠ¤í‚¤ë§ˆ**
```json
{
  "account_name": "string",           // ê³„ì •ëª… (í•„ìˆ˜)
  "documents": [                       // ë¬¸ì„œ ë°°ì—´ (í•„ìˆ˜)
    {
      "chat_bot_id": "string",         // ì±—ë´‡ ID (UUID, í•„ìˆ˜)
      "content_name": "string",        // ë¬¸ì„œ ê³ ìœ  ì‹ë³„ì (í•„ìˆ˜)
      "chunks": [                       // ì²­í¬ ë°°ì—´ (í•„ìˆ˜)
        {
          "chunk_index": 0,             // ì²­í¬ ìˆœì„œ (í•„ìˆ˜)
          "text": "string"              // ì²­í¬ í…ìŠ¤íŠ¸ (í•„ìˆ˜)
        }
      ],
      "metadata": {                     // ë©”íƒ€ë°ì´í„° (ì„ íƒ)
        "title": "string",
        "author": "string",
        "content_type": "string",
        "source_type": "string",
        "tags": ["string"]
      }
    }
  ]
}
```

#### **ìš”ì²­ ì˜ˆì‹œ**
```bash
curl -X POST "http://localhost:8000/data/insert/batch" \
  -H "Content-Type: application/json" \
  -d '{
    "account_name": "chatty",
    "documents": [
      {
        "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
        "content_name": "https://example.com/article1",
        "chunks": [
          {
            "chunk_index": 0,
            "text": "ì²« ë²ˆì§¸ ë¬¸ì„œì˜ ì²« ë¬¸ë‹¨ì…ë‹ˆë‹¤."
          }
        ],
        "metadata": {
          "title": "ì²« ë²ˆì§¸ ë¬¸ì„œ",
          "content_type": "html"
        }
      },
      {
        "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
        "content_name": "https://example.com/article2",
        "chunks": [
          {
            "chunk_index": 0,
            "text": "ë‘ ë²ˆì§¸ ë¬¸ì„œì˜ ì²« ë¬¸ë‹¨ì…ë‹ˆë‹¤."
          }
        ],
        "metadata": {
          "title": "ë‘ ë²ˆì§¸ ë¬¸ì„œ",
          "content_type": "pdf"
        }
      }
    ]
  }'
```

#### **Python ì˜ˆì‹œ**
```python
import requests

url = "http://localhost:8000/data/insert/batch"
data = {
    "account_name": "chatty",
    "documents": [
        {
            "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
            "content_name": "https://example.com/article1",
            "chunks": [
                {
                    "chunk_index": 0,
                    "text": "ì²« ë²ˆì§¸ ë¬¸ì„œì˜ ì²« ë¬¸ë‹¨ì…ë‹ˆë‹¤."
                }
            ],
            "metadata": {
                "title": "ì²« ë²ˆì§¸ ë¬¸ì„œ",
                "content_type": "html"
            }
        },
        {
            "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
            "content_name": "https://example.com/article2",
            "chunks": [
                {
                    "chunk_index": 0,
                    "text": "ë‘ ë²ˆì§¸ ë¬¸ì„œì˜ ì²« ë¬¸ë‹¨ì…ë‹ˆë‹¤."
                }
            ],
            "metadata": {
                "title": "ë‘ ë²ˆì§¸ ë¬¸ì„œ",
                "content_type": "pdf"
            }
        }
    ]
}

response = requests.post(url, json=data)
print(response.json())
```

#### **ì‘ë‹µ ìŠ¤í‚¤ë§ˆ**

**ì™„ì „ ì„±ê³µ ì‘ë‹µ**:
```json
{
  "status": "success",
  "total_documents": 5,                // ìš”ì²­í•œ ì´ ë¬¸ì„œ ìˆ˜
  "total_chunks": 10,                  // ìš”ì²­í•œ ì´ ì²­í¬ ìˆ˜
  "success_count": 5,                  // ì„±ê³µí•œ ë¬¸ì„œ ìˆ˜
  "failure_count": 0,                  // ì‹¤íŒ¨í•œ ë¬¸ì„œ ìˆ˜
  "inserted_documents": 5,             // ì‚½ì…ëœ ë¬¸ì„œ ìˆ˜
  "total_vectors": 10,                 // ì´ ì‚½ì…ëœ ë²¡í„° ìˆ˜
  "failed_content_names": [],          // ì‹¤íŒ¨í•œ ë¬¸ì„œ content_name ë¦¬ìŠ¤íŠ¸
  "results": [                         // ê°œë³„ ë¬¸ì„œ ì²˜ë¦¬ ê²°ê³¼
    {
      "doc_id": 32,
      "title": "ì²« ë²ˆì§¸ ë¬¸ì„œ",
      "total_chunks": 2,
      "success": true,
      "error": null
    }
  ],
  "postgres_insert_time_ms": 89.3,     // PostgreSQL ì‚½ì… ì‹œê°„
  "embedding_time_ms": 456.7,          // ì„ë² ë”© ìƒì„± ì‹œê°„
  "milvus_insert_time_ms": 234.7,      // Milvus ì‚½ì… ì‹œê°„
  "total_time_ms": 780.7               // ì´ ì²˜ë¦¬ ì‹œê°„
}
```

**ë¶€ë¶„ ì„±ê³µ ì‘ë‹µ** (ì¼ë¶€ ì¤‘ë³µ):
```json
{
  "status": "partial_success",
  "total_documents": 5,
  "total_chunks": 10,
  "success_count": 3,                  // 3ê°œ ì„±ê³µ
  "failure_count": 2,                  // 2ê°œ ì¤‘ë³µ ìŠ¤í‚µ
  "inserted_documents": 3,
  "total_vectors": 6,                  // ì„±ê³µí•œ ë¬¸ì„œë“¤ì˜ ì²­í¬ë§Œ ê³„ì‚°
  "failed_content_names": [            // ì¤‘ë³µëœ ë¬¸ì„œë“¤
    "https://example.com/article1",
    "https://example.com/article2"
  ],
  "results": [
    {
      "doc_id": 35,
      "title": "ì„¸ ë²ˆì§¸ ë¬¸ì„œ",
      "total_chunks": 2,
      "success": true,
      "error": null
    },
    {
      "doc_id": 0,                     // ì‹¤íŒ¨ ì‹œ 0
      "title": "ì²« ë²ˆì§¸ ë¬¸ì„œ",
      "total_chunks": 0,
      "success": false,
      "error": "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë¬¸ì„œ"
    }
  ],
  "postgres_insert_time_ms": 53.2,
  "embedding_time_ms": 273.5,
  "milvus_insert_time_ms": 141.8,
  "total_time_ms": 468.5
}
```

**ëª¨ë‘ ìŠ¤í‚µ ì‘ë‹µ** (ëª¨ë‘ ì¤‘ë³µ):
```json
{
  "status": "skipped",
  "total_documents": 5,
  "total_chunks": 10,
  "success_count": 0,
  "failure_count": 5,
  "inserted_documents": 0,
  "total_vectors": 0,
  "failed_content_names": [
    "https://example.com/article1",
    "https://example.com/article2",
    "https://example.com/article3",
    "https://example.com/article4",
    "https://example.com/article5"
  ],
  "results": [...],
  "postgres_insert_time_ms": 0.0,
  "embedding_time_ms": 0.0,
  "milvus_insert_time_ms": 0.0,
  "total_time_ms": 12.3               // ì²´í¬ ì‹œê°„ë§Œ ì†Œìš”
}
```

---

## ğŸ“Š í•„ë“œ ì„¤ëª…

### í•„ìˆ˜ í•„ë“œ

| í•„ë“œëª… | íƒ€ì… | ì„¤ëª… | ì˜ˆì‹œ |
|--------|------|------|------|
| `account_name` | string | ê³„ì •ëª… | `"chatty"` |
| `chat_bot_id` | string | ì±—ë´‡ ID (UUID) | `"fe878ea4-8b96-4a0f-a318-1b2f0edf113d"` |
| `content_name` | string | ë¬¸ì„œ ê³ ìœ  ì‹ë³„ì | `"https://example.com/article1"` |
| `chunks` | array | ì²­í¬ ë°°ì—´ | `[{"chunk_index": 0, "text": "..."}]` |
| `chunk_index` | integer | ì²­í¬ ìˆœì„œ (0ë¶€í„° ì‹œì‘) | `0, 1, 2, ...` |
| `text` | string | ì²­í¬ í…ìŠ¤íŠ¸ | `"ì‹¤ì œ ë¬¸ë‹¨ ë‚´ìš©"` |

### ì„ íƒ í•„ë“œ (ë©”íƒ€ë°ì´í„°)

| í•„ë“œëª… | íƒ€ì… | ì„¤ëª… | ì˜ˆì‹œ |
|--------|------|------|------|
| `title` | string | ë¬¸ì„œ ì œëª© | `"AI í•™ìŠµ ê°€ì´ë“œ"` |
| `author` | string | ì‘ì„±ì | `"ê¹€ê°œë°œ"` |
| `content_type` | string | ì½˜í…ì¸  íƒ€ì… | `"html"`, `"pdf"`, `"txt"` |
| `source_type` | string | ì†ŒìŠ¤ íƒ€ì… | `"url"`, `"file"` |
| `tags` | array | íƒœê·¸ ë°°ì—´ | `["AI", "ë¨¸ì‹ ëŸ¬ë‹", "í•™ìŠµ"]` |

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### ì¤‘ë³µ ì²˜ë¦¬
- ê°™ì€ `chat_bot_id`ì—ì„œ `content_name`ì€ ìœ ë‹ˆí¬í•´ì•¼ í•¨
- **ìë™ ì²˜ë¦¬**: ì¤‘ë³µ ë¬¸ì„œëŠ” ìë™ìœ¼ë¡œ ìŠ¤í‚µë˜ë©° ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ
- **ë‹¨ì¼ ì‚½ì…**: ì¤‘ë³µ ì‹œ `status: "skipped"` ë°˜í™˜
- **ë°°ì¹˜ ì‚½ì…**: ì¤‘ë³µ ë¬¸ì„œëŠ” ìŠ¤í‚µí•˜ê³  ë‚˜ë¨¸ì§€ë§Œ ì‚½ì… (`status: "partial_success"`)
- **ì„ íƒì  ì‚¬ìš©**: ì‚½ì… ì „ `/data/check-duplicates`ë¡œ ì‚¬ì „ í™•ì¸ ê°€ëŠ¥ (ê¶Œì¥í•˜ì§€ ì•ŠìŒ)

### ì²­í¬ ì¸ë±ìŠ¤
- `chunk_index`ëŠ” 0ë¶€í„° ì‹œì‘
- ê°™ì€ ë¬¸ì„œ ë‚´ì—ì„œ ì¤‘ë³µ ë¶ˆê°€
- ì—°ì†ì ì´ì§€ ì•Šì•„ë„ ë¨ (ì˜ˆ: 0, 2, 5 ê°€ëŠ¥)

### ë©”íƒ€ë°ì´í„° ë¶„ë¦¬
- **Milvus í•„í„°ë§ìš©**: `content_type`, `source_type`, `tags` ë“±
- **PostgreSQL ì €ì¥ìš©**: ëª¨ë“  ë©”íƒ€ë°ì´í„°

---

## ğŸ”„ ì²˜ë¦¬ ê³¼ì •

### 0ï¸âƒ£ ì¤‘ë³µ ì²´í¬ (ë°°ì¹˜ ì‚½ì… ì‹œ)
```python
# ì‚½ì… ì „ ì¤‘ë³µ ë¬¸ì„œ í™•ì¸
existing_content_names = await check_duplicates(content_names)

# ì¤‘ë³µëœ ë¬¸ì„œëŠ” ìŠ¤í‚µ, ìœ ì¼í•œ ë¬¸ì„œë§Œ ì‚½ì…
unique_docs = filter_duplicates(documents, existing_content_names)
```

### 1ï¸âƒ£ ë¬¸ì„œë³„ ê°œë³„ ì²˜ë¦¬
ê° ë¬¸ì„œë§ˆë‹¤ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤:

```python
for doc in unique_docs:
    try:
        # 1-1. ë©”íƒ€ë°ì´í„° ë¶„ë¦¬
        all_metadata = doc.metadata or {}
        milvus_metadata = filter_milvus_metadata(all_metadata)
        
        # 1-2. PostgreSQL ì €ì¥
        doc_id = await insert_document_with_chunks_transaction(doc)
        
        # 1-3. ì„ë² ë”© ìƒì„±
        embeddings = await embedding_service.embed_batch(chunks)
        
        # 1-4. Milvus ì €ì¥
        await milvus_client.insert_vectors(doc_id, embeddings)
        
        # ì„±ê³µ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
        successful_docs.append(doc)
        
    except Exception as e:
        # ì‹¤íŒ¨í•œ ë¬¸ì„œë§Œ ë¡¤ë°±
        if doc_id:
            await delete_document(doc_id)
        failed_docs.append(doc)
```

### 2ï¸âƒ£ ë¶€ë¶„ ì‹¤íŒ¨ ì§€ì›
- **ë°°ì¹˜ ì‚½ì…**: ì¼ë¶€ ë¬¸ì„œ ì‹¤íŒ¨í•´ë„ ì„±ê³µí•œ ë¬¸ì„œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
- **ë¡¤ë°± ì •ì±…**: ì‹¤íŒ¨í•œ ë¬¸ì„œë§Œ PostgreSQLì—ì„œ ë¡¤ë°±
- **ì‘ë‹µ**: ì„±ê³µ/ì‹¤íŒ¨ ë¬¸ì„œë¥¼ ëª¨ë‘ ë°˜í™˜

---

## âŒ ì—ëŸ¬ ì²˜ë¦¬

### ì¼ë°˜ì ì¸ ì—ëŸ¬

| ì—ëŸ¬ ì½”ë“œ | ë©”ì‹œì§€ | ì›ì¸ |
|-----------|--------|------|
| 400 | `"Validation error"` | ìš”ì²­ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜ |
| 500 | `"PostgreSQL insertion failed"` | PostgreSQL ì €ì¥ ì‹¤íŒ¨ |
| 500 | `"Milvus insertion failed"` | Milvus ì €ì¥ ì‹¤íŒ¨ |

### ì¤‘ë³µ ì²˜ë¦¬
- **ì—ëŸ¬ ë°œìƒ ì•ˆ í•¨**: ì¤‘ë³µ ë¬¸ì„œëŠ” ìë™ìœ¼ë¡œ ìŠ¤í‚µë¨
- **ì‘ë‹µ**: `status: "skipped"` (ë‹¨ì¼), `status: "partial_success"` (ë°°ì¹˜)
- **ì—ëŸ¬ ë©”ì‹œì§€**: `error_message` ë˜ëŠ” `results[].error` í•„ë“œì— í¬í•¨

### ë°°ì¹˜ ì‚½ì…ì˜ ë¶€ë¶„ ì‹¤íŒ¨
- ì¼ë¶€ ë¬¸ì„œë§Œ ì‹¤íŒ¨í•´ë„ ì „ì²´ê°€ ì‹¤íŒ¨í•˜ì§€ ì•ŠìŒ
- ì„±ê³µí•œ ë¬¸ì„œëŠ” ì •ìƒì ìœ¼ë¡œ ì‚½ì…ë¨
- ì‹¤íŒ¨í•œ ë¬¸ì„œë§Œ `failed_content_names`ì— í¬í•¨

### ì—ëŸ¬ ì‘ë‹µ ì˜ˆì‹œ
```json
{
  "detail": "PostgreSQL insertion failed: connection timeout"
}
```

---

## ğŸš€ ì„±ëŠ¥ ìµœì í™”

### ë°°ì¹˜ ì‚½ì… ê¶Œì¥
- ë‹¨ì¼ ë¬¸ì„œ ì—¬ëŸ¬ ê°œ â†’ ë°°ì¹˜ ì‚½ì… ì‚¬ìš©
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë²„í—¤ë“œ ê°ì†Œ
- ë¬¸ì„œë³„ ê°œë³„ ì²˜ë¦¬ë¡œ ì•ˆì •ì„± í–¥ìƒ

### ë¶€ë¶„ ì‹¤íŒ¨ í—ˆìš©
- ì¼ë¶€ ì‹¤íŒ¨í•´ë„ ì„±ê³µí•œ ë¬¸ì„œëŠ” ìœ ì§€
- ì¬ì‹œë„ ì‹œ ì´ë¯¸ ì‚½ì…ëœ ë¬¸ì„œëŠ” ì¤‘ë³µ ìŠ¤í‚µ
- ì•ˆì •ì„±ê³¼ íš¨ìœ¨ì„± ê· í˜•

### ì²­í¬ í¬ê¸° ê³ ë ¤
- ë„ˆë¬´ ì‘ì€ ì²­í¬: ê²€ìƒ‰ ì •í™•ë„ ì €í•˜
- ë„ˆë¬´ í° ì²­í¬: ì„ë² ë”© í’ˆì§ˆ ì €í•˜
- ê¶Œì¥: 100-500ì

### ë©”íƒ€ë°ì´í„° ìµœì í™”
- í•„í„°ë§ì— ì‚¬ìš©í•  í•„ë“œë§Œ Milvusì— ì €ì¥
- ìƒì„¸ ì •ë³´ëŠ” PostgreSQLì— ì €ì¥

---

## ğŸ“ ì˜ˆì‹œ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì›¹ ë¬¸ì„œ ì‚½ì…
```python
# ì›¹ ë¬¸ì„œë¥¼ ì²­í¬ë¡œ ë‚˜ëˆ„ì–´ ì‚½ì…
data = {
    "account_name": "chatty",
    "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
    "content_name": "https://example.com/ai-guide",
    "chunks": [
        {"chunk_index": 0, "content_hast":"f14d7a6354e6b2a0c74....", "text": "ì¸ê³µì§€ëŠ¥ ê°œìš”..."},
        {"chunk_index": 1, "text": "ë¨¸ì‹ ëŸ¬ë‹ ì•Œê³ ë¦¬ì¦˜..."},
        {"chunk_index": 2, "text": "ë”¥ëŸ¬ë‹ ê¸°ì´ˆ..."}
    ],
    "metadata": {
        "title": "AI ì™„ì „ ê°€ì´ë“œ",
        "author": "AI ì „ë¬¸ê°€",
        "content_type": "html",
        "source_type": "url",
        "tags": ["AI", "ë¨¸ì‹ ëŸ¬ë‹", "ë”¥ëŸ¬ë‹"]
    }
}
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: PDF ë¬¸ì„œ ë°°ì¹˜ ì‚½ì…
```python
# ì—¬ëŸ¬ PDF ë¬¸ì„œë¥¼ í•œ ë²ˆì— ì‚½ì…
data = {
    "account_name": "chatty",
    "documents": [
        {
            "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
            "content_name": "manual_2024.pdf",
            "chunks": [
                {"chunk_index": 0, "text": "ì œ1ì¥ ì†Œê°œ..."},
                {"chunk_index": 1, "text": "ì œ2ì¥ ì„¤ì¹˜..."}
            ],
            "metadata": {
                "title": "ì‚¬ìš©ì ë§¤ë‰´ì–¼ 2024",
                "content_type": "pdf",
                "source_type": "file"
            }
        },
        {
            "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
            "content_name": "tutorial_guide.pdf",
            "chunks": [
                {"chunk_index": 0, "text": "íŠœí† ë¦¬ì–¼ ì‹œì‘..."}
            ],
            "metadata": {
                "title": "íŠœí† ë¦¬ì–¼ ê°€ì´ë“œ",
                "content_type": "pdf",
                "source_type": "file"
            }
        }
    ]
}
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: ì¤‘ë³µ ë¬¸ì„œ ìë™ ìŠ¤í‚µ
```python
import requests

# 1ì°¨ ë°°ì¹˜ ì‚½ì… (ëª¨ë‘ ì„±ê³µ)
response1 = requests.post(
    "http://localhost:8000/data/insert/batch",
    json={
        "account_name": "chatty",
        "documents": [
            {"chat_bot_id": "bot123", "content_name": "doc1.pdf", "chunks": [...]},
            {"chat_bot_id": "bot123", "content_name": "doc2.pdf", "chunks": [...]}
        ]
    }
)
# ì‘ë‹µ: {"status": "success", "success_count": 2, "failure_count": 0}

# 2ì°¨ ë°°ì¹˜ ì‚½ì… (ì¼ë¶€ ì¤‘ë³µ)
response2 = requests.post(
    "http://localhost:8000/data/insert/batch",
    json={
        "account_name": "chatty",
        "documents": [
            {"chat_bot_id": "bot123", "content_name": "doc1.pdf", "chunks": [...]},  # ì¤‘ë³µ
            {"chat_bot_id": "bot123", "content_name": "doc3.pdf", "chunks": [...]}   # ì‹ ê·œ
        ]
    }
)
# ì‘ë‹µ: {"status": "partial_success", "success_count": 1, "failure_count": 1, 
#        "failed_content_names": ["doc1.pdf"]}
```

### ì‹œë‚˜ë¦¬ì˜¤ 4: ë¶€ë¶„ ì‹¤íŒ¨ ì²˜ë¦¬
```python
# ì¼ë¶€ ë¬¸ì„œ ì‚½ì… ì¤‘ ì„ë² ë”© ìƒì„± ì‹¤íŒ¨ ë“±ì´ ë°œìƒí•´ë„
# ì„±ê³µí•œ ë¬¸ì„œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë˜ê³  ì‹¤íŒ¨í•œ ë¬¸ì„œë§Œ ë¡¤ë°±ë¨

response = requests.post(
    "http://localhost:8000/data/insert/batch",
    json={
        "account_name": "chatty",
        "documents": [
            {"chat_bot_id": "bot123", "content_name": "doc1.pdf", "chunks": [...]},  # ì„±ê³µ
            {"chat_bot_id": "bot123", "content_name": "doc2.pdf", "chunks": [...]},  # ì„ë² ë”© ì‹¤íŒ¨ â†’ ë¡¤ë°±
            {"chat_bot_id": "bot123", "content_name": "doc3.pdf", "chunks": [...]}   # ì„±ê³µ
        ]
    }
)
# ì‘ë‹µ: {"status": "partial_success", "success_count": 2, "failure_count": 1}
# doc1ê³¼ doc3ëŠ” ì •ìƒì ìœ¼ë¡œ ì‚½ì…ë¨, doc2ë§Œ ì‹¤íŒ¨
```

---

## ğŸ”— ê´€ë ¨ API

- **ì¤‘ë³µ ê²€ì‚¬**: `/data/check-duplicates` - ì‚½ì… ì „ ì¤‘ë³µ í™•ì¸
- **ê²€ìƒ‰**: `/search/query` - ë¬¸ì„œ ê²€ìƒ‰
- **ì‚­ì œ**: `/data/document/delete` - ë¬¸ì„œ ì‚­ì œ
- **ë´‡ ì‚­ì œ**: `/data/bot/delete` - ë´‡ ì „ì²´ ì‚­ì œ
- **ì»¬ë ‰ì…˜ ê´€ë¦¬**: `/collection/*` - ì»¬ë ‰ì…˜ ê´€ë¦¬

---

## ğŸ“š ì¶”ê°€ ìë£Œ

- [ì•„í‚¤í…ì²˜ ë¬¸ì„œ](./ARCHITECTURE.md)
- [ë©”íƒ€ë°ì´í„° í•„í„°ë§](./METADATA_FILTERING.md)
- [íŒŒí‹°ì…”ë‹ ìš”ì•½](./PARTITIONING_SUMMARY.md)
- [ERD ë‹¤ì´ì–´ê·¸ë¨](./ERD.md)


## ë©”íƒ€ë°ì´í„° ì‚¬ìš©ë²•
1. metadataëŠ” json í˜•ì‹ìœ¼ë¡œ ë°›ìŠµë‹ˆë‹¤.
2. postgresqlì—ëŠ” ì „ì²´ metadataê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤.
3. milvusì—ëŠ” ì„¤ì •ëœ ë©”íƒ€ë°ì´í„°ë§Œ ë“¤ì–´ê°‘ë‹ˆë‹¤. (í•„í„°ë§í•´ì•¼í•˜ëŠ” ë°ì´í„°)
 * í•„í„°ë§í•´ì•¼í•˜ëŠ” ê°’ì´ ìˆìœ¼ë©´ ê°œë°œìì—ê²Œ ë¬¸ì˜ì˜
confg.pyì— ì •ì˜ë¨ (milvus api serverì—ì„œ ì„¤ì •ì •)
# Milvus ë©”íƒ€ë°ì´í„° í•„í„°ë§ í•„ë“œ ì„¤ì •
    MILVUS_METADATA_FIELDS: list = [
        "content_type", "source_type", "language", "tags", "category", "source_url",
    ]
