# ğŸ“„ ë¬¸ì„œ ì‚½ì… API ëª…ì„¸ì„œ

## ğŸ“‹ ê°œìš”

RAG ì‹œìŠ¤í…œì— ë¬¸ì„œë¥¼ ì‚½ì…í•˜ëŠ” APIì…ë‹ˆë‹¤. ë‹¨ì¼ ë¬¸ì„œ ì‚½ì…ê³¼ ë°°ì¹˜ ë¬¸ì„œ ì‚½ì…ì„ ì§€ì›í•©ë‹ˆë‹¤.

- **ë‹¨ì¼ ì‚½ì…**: `/data/insert` - í•˜ë‚˜ì˜ ë¬¸ì„œë¥¼ ì‚½ì…
- **ë°°ì¹˜ ì‚½ì…**: `/data/insert/batch` - ì—¬ëŸ¬ ë¬¸ì„œë¥¼ í•œ ë²ˆì— ì‚½ì…

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

### ë°ì´í„° ì €ì¥ êµ¬ì¡°
```
ğŸ“„ ë¬¸ì„œ 1ê°œ â†’ ì—¬ëŸ¬ ì²­í¬
â”œâ”€â”€ PostgreSQL (ë©”íƒ€ë°ì´í„° + ì²­í¬ í…ìŠ¤íŠ¸)
â”‚   â”œâ”€â”€ documents í…Œì´ë¸” (ë¬¸ì„œ ë©”íƒ€ë°ì´í„°)
â”‚   â””â”€â”€ document_chunks í…Œì´ë¸” (ì²­í¬ í…ìŠ¤íŠ¸)
â””â”€â”€ Milvus (ë²¡í„° ì„ë² ë”©)
    â”œâ”€â”€ embedding_dense (Dense ë²¡í„°)
    â””â”€â”€ embedding_sparse (Sparse ë²¡í„°, í–¥í›„ ê³ ë„í™”ìš©)
```

### ë°ì´í„° íë¦„
```
1. API ìš”ì²­ â†’ 2. ë©”íƒ€ë°ì´í„° ë¶„ë¦¬ â†’ 3. PostgreSQL ì €ì¥ â†’ 4. Milvus ì €ì¥
```

---

## ğŸ”— API ì—”ë“œí¬ì¸íŠ¸

### 1ï¸âƒ£ ë‹¨ì¼ ë¬¸ì„œ ì‚½ì…

#### **ì—”ë“œí¬ì¸íŠ¸**
```
POST /data/insert
```

#### **ìš”ì²­ ìŠ¤í‚¤ë§ˆ**
```json
{
  "account_name": "string",           // ê³„ì •ëª… (í•„ìˆ˜)
  "chat_bot_id": "string",            // ì±—ë´‡ ID (UUID, í•„ìˆ˜)
  "content_name": "string",           // ë¬¸ì„œ ê³ ìœ  ì‹ë³„ì (í•„ìˆ˜)
  "chunks": [                         // ì²­í¬ ë°°ì—´ (í•„ìˆ˜)
    {
      "chunk_index": 0,               // ì²­í¬ ìˆœì„œ (í•„ìˆ˜)
      "text": "string"                // ì²­í¬ í…ìŠ¤íŠ¸ (í•„ìˆ˜)
    }
  ],
  "metadata": {                       // ë©”íƒ€ë°ì´í„° (ì„ íƒ)
    "title": "string",
    "author": "string",
    "content_type": "string",
    "source_type": "string",
    "tags": ["string"]
  }
}
```

#### **ìš”ì²­ ì˜ˆì‹œ**
```bash
curl -X POST "http://localhost:8000/data/insert" \
  -H "Content-Type: application/json" \
  -d '{
    "account_name": "chatty",
    "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
    "content_name": "https://example.com/article1",
    "chunks": [
      {
        "chunk_index": 0,
        "text": "ì²« ë²ˆì§¸ ë¬¸ë‹¨ì…ë‹ˆë‹¤. ì¸ê³µì§€ëŠ¥ì— ëŒ€í•œ ë‚´ìš©ì…ë‹ˆë‹¤."
      },
      {
        "chunk_index": 1,
        "text": "ë‘ ë²ˆì§¸ ë¬¸ë‹¨ì…ë‹ˆë‹¤. ë¨¸ì‹ ëŸ¬ë‹ ì•Œê³ ë¦¬ì¦˜ì— ëŒ€í•´ ì„¤ëª…í•©ë‹ˆë‹¤."
      }
    ],
    "metadata": {
      "title": "AI í•™ìŠµ ê°€ì´ë“œ",
      "author": "ê¹€ê°œë°œ",
      "content_type": "html",
      "source_type": "url",
      "tags": ["AI", "ë¨¸ì‹ ëŸ¬ë‹", "í•™ìŠµ"]
    }
  }'
```

#### **Python ì˜ˆì‹œ**
```python
import requests

url = "http://localhost:8000/data/insert"
data = {
    "account_name": "chatty",
    "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
    "content_name": "https://example.com/article1",
    "chunks": [
        {
            "chunk_index": 0,
            "text": "ì²« ë²ˆì§¸ ë¬¸ë‹¨ì…ë‹ˆë‹¤. ì¸ê³µì§€ëŠ¥ì— ëŒ€í•œ ë‚´ìš©ì…ë‹ˆë‹¤."
        },
        {
            "chunk_index": 1,
            "text": "ë‘ ë²ˆì§¸ ë¬¸ë‹¨ì…ë‹ˆë‹¤. ë¨¸ì‹ ëŸ¬ë‹ ì•Œê³ ë¦¬ì¦˜ì— ëŒ€í•´ ì„¤ëª…í•©ë‹ˆë‹¤."
        }
    ],
    "metadata": {
        "title": "AI í•™ìŠµ ê°€ì´ë“œ",
        "author": "ê¹€ê°œë°œ",
        "content_type": "html",
        "source_type": "url",
        "tags": ["AI", "ë¨¸ì‹ ëŸ¬ë‹", "í•™ìŠµ"]
    }
}

response = requests.post(url, json=data)
print(response.json())
```

#### **ì‘ë‹µ ìŠ¤í‚¤ë§ˆ**
```json
{
  "status": "success",
  "doc_id": 32,                        // ìƒì„±ëœ ë¬¸ì„œ ID
  "inserted_vectors": 2,               // ì‚½ì…ëœ ë²¡í„° ìˆ˜
  "postgres_insert_time_ms": 45.2,     // PostgreSQL ì‚½ì… ì‹œê°„
  "milvus_insert_time_ms": 123.4,      // Milvus ì‚½ì… ì‹œê°„
  "total_time_ms": 168.6               // ì´ ì²˜ë¦¬ ì‹œê°„
}
```

---

### 2ï¸âƒ£ ë°°ì¹˜ ë¬¸ì„œ ì‚½ì…

#### **ì—”ë“œí¬ì¸íŠ¸**
```
POST /data/insert/batch
```

#### **ìš”ì²­ ìŠ¤í‚¤ë§ˆ**
```json
{
  "account_name": "string",           // ê³„ì •ëª… (í•„ìˆ˜)
  "documents": [                       // ë¬¸ì„œ ë°°ì—´ (í•„ìˆ˜)
    {
      "chat_bot_id": "string",         // ì±—ë´‡ ID (UUID, í•„ìˆ˜)
      "content_name": "string",        // ë¬¸ì„œ ê³ ìœ  ì‹ë³„ì (í•„ìˆ˜)
      "chunks": [                       // ì²­í¬ ë°°ì—´ (í•„ìˆ˜)
        {
          "chunk_index": 0,             // ì²­í¬ ìˆœì„œ (í•„ìˆ˜)
          "text": "string"              // ì²­í¬ í…ìŠ¤íŠ¸ (í•„ìˆ˜)
        }
      ],
      "metadata": {                     // ë©”íƒ€ë°ì´í„° (ì„ íƒ)
        "title": "string",
        "author": "string",
        "content_type": "string",
        "source_type": "string",
        "tags": ["string"]
      }
    }
  ]
}
```

#### **ìš”ì²­ ì˜ˆì‹œ**
```bash
curl -X POST "http://localhost:8000/data/insert/batch" \
  -H "Content-Type: application/json" \
  -d '{
    "account_name": "chatty",
    "documents": [
      {
        "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
        "content_name": "https://example.com/article1",
        "chunks": [
          {
            "chunk_index": 0,
            "text": "ì²« ë²ˆì§¸ ë¬¸ì„œì˜ ì²« ë¬¸ë‹¨ì…ë‹ˆë‹¤."
          }
        ],
        "metadata": {
          "title": "ì²« ë²ˆì§¸ ë¬¸ì„œ",
          "content_type": "html"
        }
      },
      {
        "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
        "content_name": "https://example.com/article2",
        "chunks": [
          {
            "chunk_index": 0,
            "text": "ë‘ ë²ˆì§¸ ë¬¸ì„œì˜ ì²« ë¬¸ë‹¨ì…ë‹ˆë‹¤."
          }
        ],
        "metadata": {
          "title": "ë‘ ë²ˆì§¸ ë¬¸ì„œ",
          "content_type": "pdf"
        }
      }
    ]
  }'
```

#### **Python ì˜ˆì‹œ**
```python
import requests

url = "http://localhost:8000/data/insert/batch"
data = {
    "account_name": "chatty",
    "documents": [
        {
            "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
            "content_name": "https://example.com/article1",
            "chunks": [
                {
                    "chunk_index": 0,
                    "text": "ì²« ë²ˆì§¸ ë¬¸ì„œì˜ ì²« ë¬¸ë‹¨ì…ë‹ˆë‹¤."
                }
            ],
            "metadata": {
                "title": "ì²« ë²ˆì§¸ ë¬¸ì„œ",
                "content_type": "html"
            }
        },
        {
            "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
            "content_name": "https://example.com/article2",
            "chunks": [
                {
                    "chunk_index": 0,
                    "text": "ë‘ ë²ˆì§¸ ë¬¸ì„œì˜ ì²« ë¬¸ë‹¨ì…ë‹ˆë‹¤."
                }
            ],
            "metadata": {
                "title": "ë‘ ë²ˆì§¸ ë¬¸ì„œ",
                "content_type": "pdf"
            }
        }
    ]
}

response = requests.post(url, json=data)
print(response.json())
```

#### **ì‘ë‹µ ìŠ¤í‚¤ë§ˆ**
```json
{
  "status": "success",
  "inserted_documents": 2,             // ì‚½ì…ëœ ë¬¸ì„œ ìˆ˜
  "total_vectors": 2,                  // ì´ ì‚½ì…ëœ ë²¡í„° ìˆ˜
  "postgres_insert_time_ms": 89.3,     // PostgreSQL ì‚½ì… ì‹œê°„
  "milvus_insert_time_ms": 234.7,      // Milvus ì‚½ì… ì‹œê°„
  "total_time_ms": 324.0               // ì´ ì²˜ë¦¬ ì‹œê°„
}
```

---

## ğŸ“Š í•„ë“œ ì„¤ëª…

### í•„ìˆ˜ í•„ë“œ

| í•„ë“œëª… | íƒ€ì… | ì„¤ëª… | ì˜ˆì‹œ |
|--------|------|------|------|
| `account_name` | string | ê³„ì •ëª… | `"chatty"` |
| `chat_bot_id` | string | ì±—ë´‡ ID (UUID) | `"fe878ea4-8b96-4a0f-a318-1b2f0edf113d"` |
| `content_name` | string | ë¬¸ì„œ ê³ ìœ  ì‹ë³„ì | `"https://example.com/article1"` |
| `chunks` | array | ì²­í¬ ë°°ì—´ | `[{"chunk_index": 0, "text": "..."}]` |
| `chunk_index` | integer | ì²­í¬ ìˆœì„œ (0ë¶€í„° ì‹œì‘) | `0, 1, 2, ...` |
| `text` | string | ì²­í¬ í…ìŠ¤íŠ¸ | `"ì‹¤ì œ ë¬¸ë‹¨ ë‚´ìš©"` |

### ì„ íƒ í•„ë“œ (ë©”íƒ€ë°ì´í„°)

| í•„ë“œëª… | íƒ€ì… | ì„¤ëª… | ì˜ˆì‹œ |
|--------|------|------|------|
| `title` | string | ë¬¸ì„œ ì œëª© | `"AI í•™ìŠµ ê°€ì´ë“œ"` |
| `author` | string | ì‘ì„±ì | `"ê¹€ê°œë°œ"` |
| `content_type` | string | ì½˜í…ì¸  íƒ€ì… | `"html"`, `"pdf"`, `"txt"` |
| `source_type` | string | ì†ŒìŠ¤ íƒ€ì… | `"url"`, `"file"` |
| `tags` | array | íƒœê·¸ ë°°ì—´ | `["AI", "ë¨¸ì‹ ëŸ¬ë‹", "í•™ìŠµ"]` |

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### ìœ ë‹ˆí¬ ì œì•½ì¡°ê±´
- ê°™ì€ `chat_bot_id`ì—ì„œ `content_name`ì€ ìœ ë‹ˆí¬í•´ì•¼ í•¨
- ì¤‘ë³µ ì‚½ì… ì‹œ ì—ëŸ¬ ë°œìƒ: `"Document with content_name '...' already exists"`

### ì²­í¬ ì¸ë±ìŠ¤
- `chunk_index`ëŠ” 0ë¶€í„° ì‹œì‘
- ê°™ì€ ë¬¸ì„œ ë‚´ì—ì„œ ì¤‘ë³µ ë¶ˆê°€
- ì—°ì†ì ì´ì§€ ì•Šì•„ë„ ë¨ (ì˜ˆ: 0, 2, 5 ê°€ëŠ¥)

### ë©”íƒ€ë°ì´í„° ë¶„ë¦¬
- **Milvus í•„í„°ë§ìš©**: `content_type`, `source_type`, `tags` ë“±
- **PostgreSQL ì €ì¥ìš©**: ëª¨ë“  ë©”íƒ€ë°ì´í„°

---

## ğŸ”„ ì²˜ë¦¬ ê³¼ì •

### 1ï¸âƒ£ ë©”íƒ€ë°ì´í„° ë¶„ë¦¬
```python
# ì „ì²´ ë©”íƒ€ë°ì´í„°ë¥¼ PostgreSQLì— ì €ì¥
all_metadata = request.metadata or {}

# Milvus í•„í„°ë§ìš© ë©”íƒ€ë°ì´í„°ë§Œ ì¶”ì¶œ
milvus_metadata = filter_milvus_metadata(all_metadata)
```

### 2ï¸âƒ£ PostgreSQL ì €ì¥
```sql
-- documents í…Œì´ë¸”
INSERT INTO documents (chat_bot_id, content_name, chunk_count, metadata)
VALUES (?, ?, ?, ?)

-- document_chunks í…Œì´ë¸”
INSERT INTO document_chunks (doc_id, chat_bot_id, chunk_index, chunk_text)
VALUES (?, ?, ?, ?)
```

### 3ï¸âƒ£ Milvus ì €ì¥
```python
# ë²¡í„° ì„ë² ë”© ìƒì„±
embeddings = await embedding_service.embed_batch([chunk["text"] for chunk in chunks])

# Milvusì— ë²¡í„° ì €ì¥
entities = [
    [doc_id] * len(chunks),                    # doc_id
    [chat_bot_id] * len(chunks),               # chat_bot_id
    [content_name] * len(chunks),               # content_name
    [chunk["chunk_index"] for chunk in chunks], # chunk_index
    embeddings,                                 # embedding_dense
    [milvus_metadata] * len(chunks),           # metadata
    [sparse_embeddings] * len(chunks)          # embedding_sparse (í–¥í›„)
]
```

---

## âŒ ì—ëŸ¬ ì²˜ë¦¬

### ì¼ë°˜ì ì¸ ì—ëŸ¬

| ì—ëŸ¬ ì½”ë“œ | ë©”ì‹œì§€ | ì›ì¸ |
|-----------|--------|------|
| 400 | `"Validation error"` | ìš”ì²­ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜ |
| 409 | `"Document already exists"` | ì¤‘ë³µëœ content_name |
| 500 | `"PostgreSQL insertion failed"` | PostgreSQL ì €ì¥ ì‹¤íŒ¨ |
| 500 | `"Milvus insertion failed"` | Milvus ì €ì¥ ì‹¤íŒ¨ |

### ì—ëŸ¬ ì‘ë‹µ ì˜ˆì‹œ
```json
{
  "detail": "Document with content_name 'https://example.com/article1' already exists for this chat_bot_id"
}
```

---

## ğŸš€ ì„±ëŠ¥ ìµœì í™”

### ë°°ì¹˜ ì‚½ì… ê¶Œì¥
- ë‹¨ì¼ ë¬¸ì„œ ì—¬ëŸ¬ ê°œ â†’ ë°°ì¹˜ ì‚½ì… ì‚¬ìš©
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë²„í—¤ë“œ ê°ì†Œ
- íŠ¸ëœì­ì…˜ íš¨ìœ¨ì„± í–¥ìƒ

### ì²­í¬ í¬ê¸° ê³ ë ¤
- ë„ˆë¬´ ì‘ì€ ì²­í¬: ê²€ìƒ‰ ì •í™•ë„ ì €í•˜
- ë„ˆë¬´ í° ì²­í¬: ì„ë² ë”© í’ˆì§ˆ ì €í•˜
- ê¶Œì¥: 100-500ì

### ë©”íƒ€ë°ì´í„° ìµœì í™”
- í•„í„°ë§ì— ì‚¬ìš©í•  í•„ë“œë§Œ Milvusì— ì €ì¥
- ìƒì„¸ ì •ë³´ëŠ” PostgreSQLì— ì €ì¥

---

## ğŸ“ ì˜ˆì‹œ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì›¹ ë¬¸ì„œ ì‚½ì…
```python
# ì›¹ ë¬¸ì„œë¥¼ ì²­í¬ë¡œ ë‚˜ëˆ„ì–´ ì‚½ì…
data = {
    "account_name": "chatty",
    "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
    "content_name": "https://example.com/ai-guide",
    "chunks": [
        {"chunk_index": 0, "text": "ì¸ê³µì§€ëŠ¥ ê°œìš”..."},
        {"chunk_index": 1, "text": "ë¨¸ì‹ ëŸ¬ë‹ ì•Œê³ ë¦¬ì¦˜..."},
        {"chunk_index": 2, "text": "ë”¥ëŸ¬ë‹ ê¸°ì´ˆ..."}
    ],
    "metadata": {
        "title": "AI ì™„ì „ ê°€ì´ë“œ",
        "author": "AI ì „ë¬¸ê°€",
        "content_type": "html",
        "source_type": "url",
        "tags": ["AI", "ë¨¸ì‹ ëŸ¬ë‹", "ë”¥ëŸ¬ë‹"]
    }
}
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: PDF ë¬¸ì„œ ë°°ì¹˜ ì‚½ì…
```python
# ì—¬ëŸ¬ PDF ë¬¸ì„œë¥¼ í•œ ë²ˆì— ì‚½ì…
data = {
    "account_name": "chatty",
    "documents": [
        {
            "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
            "content_name": "manual_2024.pdf",
            "chunks": [
                {"chunk_index": 0, "text": "ì œ1ì¥ ì†Œê°œ..."},
                {"chunk_index": 1, "text": "ì œ2ì¥ ì„¤ì¹˜..."}
            ],
            "metadata": {
                "title": "ì‚¬ìš©ì ë§¤ë‰´ì–¼ 2024",
                "content_type": "pdf",
                "source_type": "file"
            }
        },
        {
            "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
            "content_name": "tutorial_guide.pdf",
            "chunks": [
                {"chunk_index": 0, "text": "íŠœí† ë¦¬ì–¼ ì‹œì‘..."}
            ],
            "metadata": {
                "title": "íŠœí† ë¦¬ì–¼ ê°€ì´ë“œ",
                "content_type": "pdf",
                "source_type": "file"
            }
        }
    ]
}
```

---

## ğŸ”— ê´€ë ¨ API

- **ê²€ìƒ‰**: `/search/query` - ë¬¸ì„œ ê²€ìƒ‰
- **ì‚­ì œ**: `/data/delete/document/{content_name}` - ë¬¸ì„œ ì‚­ì œ
- **ë´‡ ì‚­ì œ**: `/data/delete/bot/{chat_bot_id}` - ë´‡ ì „ì²´ ì‚­ì œ
- **ì»¬ë ‰ì…˜ ê´€ë¦¬**: `/collection/*` - ì»¬ë ‰ì…˜ ê´€ë¦¬

---

## ğŸ“š ì¶”ê°€ ìë£Œ

- [ì•„í‚¤í…ì²˜ ë¬¸ì„œ](./ARCHITECTURE.md)
- [ë©”íƒ€ë°ì´í„° í•„í„°ë§](./METADATA_FILTERING.md)
- [íŒŒí‹°ì…”ë‹ ìš”ì•½](./PARTITIONING_SUMMARY.md)
- [ERD ë‹¤ì´ì–´ê·¸ë¨](./ERD.md)


## ë©”íƒ€ë°ì´í„° ì‚¬ìš©ë²•
1. metadataëŠ” json í˜•ì‹ìœ¼ë¡œ ë°›ìŠµë‹ˆë‹¤.
2. postgresqlì—ëŠ” ì „ì²´ metadataê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤.
3. milvusì—ëŠ” ì„¤ì •ëœ ë©”íƒ€ë°ì´í„°ë§Œ ë“¤ì–´ê°‘ë‹ˆë‹¤. (í•„í„°ë§í•´ì•¼í•˜ëŠ” ë°ì´í„°)
 * í•„í„°ë§í•´ì•¼í•˜ëŠ” ê°’ì´ ìˆìœ¼ë©´ ê°œë°œìì—ê²Œ ë¬¸ì˜ì˜
confg.pyì— ì •ì˜ë¨
# Milvus ë©”íƒ€ë°ì´í„° í•„í„°ë§ í•„ë“œ ì„¤ì •
    MILVUS_METADATA_FIELDS: list = [
        "content_type", "source_type", "language", "tags", "category", "source_url",
    ]
