# 📄 문서 삽입 API 명세서

## 📋 개요

RAG 시스템에 문서를 삽입하는 API입니다. 단일 문서 삽입과 배치 문서 삽입을 지원합니다.

- **단일 삽입**: `/data/insert` - 하나의 문서를 삽입
- **배치 삽입**: `/data/insert/batch` - 여러 문서를 한 번에 삽입

## 🏗️ 아키텍처

### 데이터 저장 구조
```
📄 문서 1개 → 여러 청크
├── PostgreSQL (메타데이터 + 청크 텍스트)
│   ├── documents 테이블 (문서 메타데이터)
│   └── document_chunks 테이블 (청크 텍스트)
└── Milvus (벡터 임베딩)
    ├── embedding_dense (Dense 벡터)
    └── embedding_sparse (Sparse 벡터, 향후 고도화용)
```

### 데이터 흐름
```
1. API 요청 → 2. 메타데이터 분리 → 3. PostgreSQL 저장 → 4. Milvus 저장
```

---

## 🔗 API 엔드포인트

### 1️⃣ 단일 문서 삽입

#### **엔드포인트**
```
POST /data/insert
```

#### **요청 스키마**
```json
{
  "account_name": "string",           // 계정명 (필수)
  "chat_bot_id": "string",            // 챗봇 ID (UUID, 필수)
  "content_name": "string",           // 문서 고유 식별자 (필수)
  "chunks": [                         // 청크 배열 (필수)
    {
      "chunk_index": 0,               // 청크 순서 (필수)
      "text": "string"                // 청크 텍스트 (필수)
    }
  ],
  "metadata": {                       // 메타데이터 (선택)
    "title": "string",
    "author": "string",
    "content_type": "string",
    "source_type": "string",
    "tags": ["string"]
  }
}
```

#### **요청 예시**
```bash
curl -X POST "http://localhost:8000/data/insert" \
  -H "Content-Type: application/json" \
  -d '{
    "account_name": "chatty",
    "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
    "content_name": "https://example.com/article1",
    "chunks": [
      {
        "chunk_index": 0,
        "text": "첫 번째 문단입니다. 인공지능에 대한 내용입니다."
      },
      {
        "chunk_index": 1,
        "text": "두 번째 문단입니다. 머신러닝 알고리즘에 대해 설명합니다."
      }
    ],
    "metadata": {
      "title": "AI 학습 가이드",
      "author": "김개발",
      "content_type": "html",
      "source_type": "url",
      "tags": ["AI", "머신러닝", "학습"]
    }
  }'
```

#### **Python 예시**
```python
import requests

url = "http://localhost:8000/data/insert"
data = {
    "account_name": "chatty",
    "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
    "content_name": "https://example.com/article1",
    "chunks": [
        {
            "chunk_index": 0,
            "text": "첫 번째 문단입니다. 인공지능에 대한 내용입니다."
        },
        {
            "chunk_index": 1,
            "text": "두 번째 문단입니다. 머신러닝 알고리즘에 대해 설명합니다."
        }
    ],
    "metadata": {
        "title": "AI 학습 가이드",
        "author": "김개발",
        "content_type": "html",
        "source_type": "url",
        "tags": ["AI", "머신러닝", "학습"]
    }
}

response = requests.post(url, json=data)
print(response.json())
```

#### **응답 스키마**
```json
{
  "status": "success",
  "doc_id": 32,                        // 생성된 문서 ID
  "inserted_vectors": 2,               // 삽입된 벡터 수
  "postgres_insert_time_ms": 45.2,     // PostgreSQL 삽입 시간
  "milvus_insert_time_ms": 123.4,      // Milvus 삽입 시간
  "total_time_ms": 168.6               // 총 처리 시간
}
```

---

### 2️⃣ 배치 문서 삽입

#### **엔드포인트**
```
POST /data/insert/batch
```

#### **요청 스키마**
```json
{
  "account_name": "string",           // 계정명 (필수)
  "documents": [                       // 문서 배열 (필수)
    {
      "chat_bot_id": "string",         // 챗봇 ID (UUID, 필수)
      "content_name": "string",        // 문서 고유 식별자 (필수)
      "chunks": [                       // 청크 배열 (필수)
        {
          "chunk_index": 0,             // 청크 순서 (필수)
          "text": "string"              // 청크 텍스트 (필수)
        }
      ],
      "metadata": {                     // 메타데이터 (선택)
        "title": "string",
        "author": "string",
        "content_type": "string",
        "source_type": "string",
        "tags": ["string"]
      }
    }
  ]
}
```

#### **요청 예시**
```bash
curl -X POST "http://localhost:8000/data/insert/batch" \
  -H "Content-Type: application/json" \
  -d '{
    "account_name": "chatty",
    "documents": [
      {
        "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
        "content_name": "https://example.com/article1",
        "chunks": [
          {
            "chunk_index": 0,
            "text": "첫 번째 문서의 첫 문단입니다."
          }
        ],
        "metadata": {
          "title": "첫 번째 문서",
          "content_type": "html"
        }
      },
      {
        "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
        "content_name": "https://example.com/article2",
        "chunks": [
          {
            "chunk_index": 0,
            "text": "두 번째 문서의 첫 문단입니다."
          }
        ],
        "metadata": {
          "title": "두 번째 문서",
          "content_type": "pdf"
        }
      }
    ]
  }'
```

#### **Python 예시**
```python
import requests

url = "http://localhost:8000/data/insert/batch"
data = {
    "account_name": "chatty",
    "documents": [
        {
            "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
            "content_name": "https://example.com/article1",
            "chunks": [
                {
                    "chunk_index": 0,
                    "text": "첫 번째 문서의 첫 문단입니다."
                }
            ],
            "metadata": {
                "title": "첫 번째 문서",
                "content_type": "html"
            }
        },
        {
            "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
            "content_name": "https://example.com/article2",
            "chunks": [
                {
                    "chunk_index": 0,
                    "text": "두 번째 문서의 첫 문단입니다."
                }
            ],
            "metadata": {
                "title": "두 번째 문서",
                "content_type": "pdf"
            }
        }
    ]
}

response = requests.post(url, json=data)
print(response.json())
```

#### **응답 스키마**
```json
{
  "status": "success",
  "inserted_documents": 2,             // 삽입된 문서 수
  "total_vectors": 2,                  // 총 삽입된 벡터 수
  "postgres_insert_time_ms": 89.3,     // PostgreSQL 삽입 시간
  "milvus_insert_time_ms": 234.7,      // Milvus 삽입 시간
  "total_time_ms": 324.0               // 총 처리 시간
}
```

---

## 📊 필드 설명

### 필수 필드

| 필드명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| `account_name` | string | 계정명 | `"chatty"` |
| `chat_bot_id` | string | 챗봇 ID (UUID) | `"fe878ea4-8b96-4a0f-a318-1b2f0edf113d"` |
| `content_name` | string | 문서 고유 식별자 | `"https://example.com/article1"` |
| `chunks` | array | 청크 배열 | `[{"chunk_index": 0, "text": "..."}]` |
| `chunk_index` | integer | 청크 순서 (0부터 시작) | `0, 1, 2, ...` |
| `text` | string | 청크 텍스트 | `"실제 문단 내용"` |

### 선택 필드 (메타데이터)

| 필드명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| `title` | string | 문서 제목 | `"AI 학습 가이드"` |
| `author` | string | 작성자 | `"김개발"` |
| `content_type` | string | 콘텐츠 타입 | `"html"`, `"pdf"`, `"txt"` |
| `source_type` | string | 소스 타입 | `"url"`, `"file"` |
| `tags` | array | 태그 배열 | `["AI", "머신러닝", "학습"]` |

---

## ⚠️ 주의사항

### 유니크 제약조건
- 같은 `chat_bot_id`에서 `content_name`은 유니크해야 함
- 중복 삽입 시 에러 발생: `"Document with content_name '...' already exists"`

### 청크 인덱스
- `chunk_index`는 0부터 시작
- 같은 문서 내에서 중복 불가
- 연속적이지 않아도 됨 (예: 0, 2, 5 가능)

### 메타데이터 분리
- **Milvus 필터링용**: `content_type`, `source_type`, `tags` 등
- **PostgreSQL 저장용**: 모든 메타데이터

---

## 🔄 처리 과정

### 1️⃣ 메타데이터 분리
```python
# 전체 메타데이터를 PostgreSQL에 저장
all_metadata = request.metadata or {}

# Milvus 필터링용 메타데이터만 추출
milvus_metadata = filter_milvus_metadata(all_metadata)
```

### 2️⃣ PostgreSQL 저장
```sql
-- documents 테이블
INSERT INTO documents (chat_bot_id, content_name, chunk_count, metadata)
VALUES (?, ?, ?, ?)

-- document_chunks 테이블
INSERT INTO document_chunks (doc_id, chat_bot_id, chunk_index, chunk_text)
VALUES (?, ?, ?, ?)
```

### 3️⃣ Milvus 저장
```python
# 벡터 임베딩 생성
embeddings = await embedding_service.embed_batch([chunk["text"] for chunk in chunks])

# Milvus에 벡터 저장
entities = [
    [doc_id] * len(chunks),                    # doc_id
    [chat_bot_id] * len(chunks),               # chat_bot_id
    [content_name] * len(chunks),               # content_name
    [chunk["chunk_index"] for chunk in chunks], # chunk_index
    embeddings,                                 # embedding_dense
    [milvus_metadata] * len(chunks),           # metadata
    [sparse_embeddings] * len(chunks)          # embedding_sparse (향후)
]
```

---

## ❌ 에러 처리

### 일반적인 에러

| 에러 코드 | 메시지 | 원인 |
|-----------|--------|------|
| 400 | `"Validation error"` | 요청 데이터 형식 오류 |
| 409 | `"Document already exists"` | 중복된 content_name |
| 500 | `"PostgreSQL insertion failed"` | PostgreSQL 저장 실패 |
| 500 | `"Milvus insertion failed"` | Milvus 저장 실패 |

### 에러 응답 예시
```json
{
  "detail": "Document with content_name 'https://example.com/article1' already exists for this chat_bot_id"
}
```

---

## 🚀 성능 최적화

### 배치 삽입 권장
- 단일 문서 여러 개 → 배치 삽입 사용
- 네트워크 오버헤드 감소
- 트랜잭션 효율성 향상

### 청크 크기 고려
- 너무 작은 청크: 검색 정확도 저하
- 너무 큰 청크: 임베딩 품질 저하
- 권장: 100-500자

### 메타데이터 최적화
- 필터링에 사용할 필드만 Milvus에 저장
- 상세 정보는 PostgreSQL에 저장

---

## 📝 예시 시나리오

### 시나리오 1: 웹 문서 삽입
```python
# 웹 문서를 청크로 나누어 삽입
data = {
    "account_name": "chatty",
    "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
    "content_name": "https://example.com/ai-guide",
    "chunks": [
        {"chunk_index": 0, "text": "인공지능 개요..."},
        {"chunk_index": 1, "text": "머신러닝 알고리즘..."},
        {"chunk_index": 2, "text": "딥러닝 기초..."}
    ],
    "metadata": {
        "title": "AI 완전 가이드",
        "author": "AI 전문가",
        "content_type": "html",
        "source_type": "url",
        "tags": ["AI", "머신러닝", "딥러닝"]
    }
}
```

### 시나리오 2: PDF 문서 배치 삽입
```python
# 여러 PDF 문서를 한 번에 삽입
data = {
    "account_name": "chatty",
    "documents": [
        {
            "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
            "content_name": "manual_2024.pdf",
            "chunks": [
                {"chunk_index": 0, "text": "제1장 소개..."},
                {"chunk_index": 1, "text": "제2장 설치..."}
            ],
            "metadata": {
                "title": "사용자 매뉴얼 2024",
                "content_type": "pdf",
                "source_type": "file"
            }
        },
        {
            "chat_bot_id": "fe878ea4-8b96-4a0f-a318-1b2f0edf113d",
            "content_name": "tutorial_guide.pdf",
            "chunks": [
                {"chunk_index": 0, "text": "튜토리얼 시작..."}
            ],
            "metadata": {
                "title": "튜토리얼 가이드",
                "content_type": "pdf",
                "source_type": "file"
            }
        }
    ]
}
```

---

## 🔗 관련 API

- **검색**: `/search/query` - 문서 검색
- **삭제**: `/data/delete/document/{content_name}` - 문서 삭제
- **봇 삭제**: `/data/delete/bot/{chat_bot_id}` - 봇 전체 삭제
- **컬렉션 관리**: `/collection/*` - 컬렉션 관리

---

## 📚 추가 자료

- [아키텍처 문서](./ARCHITECTURE.md)
- [메타데이터 필터링](./METADATA_FILTERING.md)
- [파티셔닝 요약](./PARTITIONING_SUMMARY.md)
- [ERD 다이어그램](./ERD.md)


## 메타데이터 사용법
1. metadata는 json 형식으로 받습니다.
2. postgresql에는 전체 metadata가 들어갑니다.
3. milvus에는 설정된 메타데이터만 들어갑니다. (필터링해야하는 데이터)
 * 필터링해야하는 값이 있으면 개발자에게 문의의
confg.py에 정의됨
# Milvus 메타데이터 필터링 필드 설정
    MILVUS_METADATA_FIELDS: list = [
        "content_type", "source_type", "language", "tags", "category", "source_url",
    ]
